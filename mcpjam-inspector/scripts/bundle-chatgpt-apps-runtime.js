import { build } from "esbuild";
import { writeFileSync } from "fs";
import { fileURLToPath } from "url";
import { dirname, join } from "path";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

try {
  const result = await build({
    entryPoints: [
      join(__dirname, "../server/routes/apps/chatgpt-apps/OpenAIRuntime.ts"),
    ],
    bundle: true,
    write: false,
    format: "iife",
    platform: "browser",
    target: "es2020",
    minify: false,
  });

  const bundledCode = result.outputFiles[0].text;
  const serializedCode = JSON.stringify(bundledCode);

  const outputContent = `// This file is auto-generated by scripts/bundle-chatgpt-apps-runtime.js
// Do not edit directly - modify server/routes/apps/chatgpt-apps/OpenAIRuntime.ts instead

export const CHATGPT_APPS_RUNTIME_SCRIPT = ${serializedCode};
`;

  const outputTsPath = join(
    __dirname,
    "../server/routes/apps/chatgpt-apps/OpenAIRuntime.bundled.ts",
  );
  writeFileSync(outputTsPath, outputContent);
  console.log("✅ Successfully bundled ChatGPT Apps runtime script");
} catch (error) {
  console.error("❌ Failed to bundle ChatGPT Apps runtime script:", error);
  process.exit(1);
}
