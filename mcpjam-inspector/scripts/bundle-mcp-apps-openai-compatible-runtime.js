import { build } from "esbuild";
import { writeFileSync } from "fs";
import { fileURLToPath } from "url";
import { dirname, join } from "path";

const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

try {
  const result = await build({
    entryPoints: [
      join(
        __dirname,
        "../server/routes/apps/mcp-apps/McpAppsOpenAICompatibleRuntime.ts",
      ),
    ],
    bundle: true,
    write: false,
    format: "iife",
    platform: "browser",
    target: "es2020",
    minify: false,
  });

  const bundledCode = result.outputFiles[0].text;
  const serializedCode = JSON.stringify(bundledCode);

  const outputContent = `// This file is auto-generated by scripts/bundle-mcp-apps-openai-compatible-runtime.js
// Do not edit directly - modify server/routes/apps/mcp-apps/McpAppsOpenAICompatibleRuntime.ts instead

export const MCP_APPS_OPENAI_COMPATIBLE_RUNTIME_SCRIPT = ${serializedCode};
`;

  const outputTsPath = join(
    __dirname,
    "../server/routes/apps/mcp-apps/McpAppsOpenAICompatibleRuntime.bundled.ts",
  );
  writeFileSync(outputTsPath, outputContent);
  console.log(
    "✅ Successfully bundled MCP Apps OpenAI compatible runtime script",
  );
} catch (error) {
  console.error("❌ Failed to bundle OpenAI compat runtime script:", error);
  process.exit(1);
}
